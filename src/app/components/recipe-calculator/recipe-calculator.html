<div class="calculator-container">
  <h1>Recipe Calculator</h1>

  <div class="grid">
    <!-- Form Side -->
    <div class="card" [formGroup]="recipeForm">
      <h2>Recipe Details</h2>

      <div class="form-group">
        <label for="recipe-name">Recipe Name</label>
        <input id="recipe-name" type="text" formControlName="name" placeholder="e.g. Country Loaf">
      </div>

      <div class="form-group">
        <label for="recipe-category">Category</label>
        <select id="recipe-category" formControlName="category">
          @for (cat of recipeCategories; track cat) {
            <option [value]="cat">{{cat}}</option>
          }
        </select>
      </div>

      @if (recipeForm.get('category')?.value === 'BREAD' || recipeForm.get('category')?.value === 'BAGEL') {
        <div class="form-group">
          <label for="flavor-profile">Flavor Profile (Badge)</label>
          <select id="flavor-profile" formControlName="flavorProfile">
            <option [ngValue]="null">Select Profile (Optional)</option>
            @for (profile of flavorProfiles; track profile) {
              <option [value]="profile">{{profile}}</option>
            }
          </select>
          <small class="form-hint">Choose 'PLAIN' for standard bread to show the badge.</small>
        </div>
      }

      <div class="form-group">
        <label for="recipe-price">Price ($)</label>
        <input id="recipe-price" type="number" formControlName="price" placeholder="e.g. 12">
      </div>

      <div class="form-group">
        <label for="recipe-description">Description</label>
        <textarea id="recipe-description" formControlName="description" rows="3" placeholder="Tell customers about this item..."></textarea>
      </div>

      <div class="form-group">
        <label>Recipe Photos</label>
        <div class="image-upload-wrapper">
          <div class="image-grid-edit">
            @for (img of recipeForm.get('images')?.value; track img; let i = $index) {
              <div class="image-preview-mini">
                <img [src]="img" alt="Preview">
                <button type="button" class="btn-remove-image" (click)="removeImage(i)">√ó</button>
              </div>
            }
            <div class="upload-placeholder-mini" (click)="fileInput.click()">
              <span class="icon">üì∏</span>
              <span>Add Photo</span>
            </div>
          </div>
          <input #fileInput type="file" (change)="onFileSelected($event)" accept="image/*" multiple style="display: none">
        </div>
      </div>

      <div class="form-group">
        <label for="levain-hydration">Levain Hydration (%)</label>
        <input id="levain-hydration" type="number" formControlName="levainHydration">
      </div>

      <div class="form-group">
        <label for="serving-size">Serving Size (g)</label>
        <input id="serving-size" type="number" formControlName="servingSizeGrams" placeholder="e.g. 50">
      </div>

      <div class="scaling-grid">
        <div class="form-group">
          <label for="current-units">Current Units</label>
          <input id="current-units" type="number" formControlName="currentUnits">
        </div>
        <div class="form-group">
          <label for="target-units">Target Units (Scaling)</label>
          <input id="target-units" type="number" formControlName="targetUnits">
        </div>
      </div>

      <h3>Ingredients</h3>
      <div formArrayName="ingredients">
        @for (ingredient of ingredients.controls; track ingredient; let i = $index) {
          <div [formGroupName]="i" class="ingredient-row">
            <div class="search-container">
              <input type="text" formControlName="name" placeholder="Name" (input)="onSearch($event, i)" (focus)="onSearch($event, i)" (blur)="onBlur()" autocomplete="off">
              @if (activeSearchIndex() === i && searchResults().length > 0) {
                <div class="search-results-wrapper">
                  <ul class="search-results">
                    @for (item of searchResults(); track item.name) {
                      <li (mousedown)="selectIngredient(item, i)">
                        <div class="search-item-info">
                          <span class="search-item-name">{{item.name}}</span>
                          <span class="search-item-meta">{{item.nutrition.caloriesPer100g | number:'1.0-0'}} kcal/100g</span>
                        </div>
                      </li>
                    }
                  </ul>
                </div>
              }
            </div>
            <input type="number" formControlName="weight" placeholder="Grams">
            <select formControlName="type">
              @for (type of ingredientTypes; track type) {
                <option [value]="type">{{type}}</option>
              }
            </select>
            <button type="button" class="btn-delete-product" (click)="removeIngredient(i)">√ó</button>
          </div>
        }
      </div>


      <button type="button" class="btn-primary" (click)="addIngredient()">Add Ingredient</button>

      <div class="save-section">
        @if (hasUnsavedChanges()) {
          <p class="unsaved-hint">‚ö†Ô∏è You have unsaved changes in this recipe.</p>
        }
        <button type="button" class="btn-save" (click)="saveRecipe()">Save This Recipe</button>
      </div>
    </div>

    <!-- Results Side -->
    <div class="results-column">
      @if (calculatedRecipe(); as recipe) {
        <div class="card results">
          <h2>Baker's Math Results</h2>

          <div class="stats-grid">
            <div class="stat-box">
              <span class="label">Total Flour</span>
              <span class="value">{{recipe.totalFlour | number:'1.0-2'}}g</span>
            </div>
            <div class="stat-box">
              <span class="label">Total Water</span>
              <span class="value">{{recipe.totalWater | number:'1.0-2'}}g</span>
            </div>
            <div class="stat-box highlight">
              <span class="label">True Hydration</span>
              <span class="value">{{recipe.trueHydration | percent:'1.1-1'}}</span>
            </div>
          </div>

          <h3>Ingredient Breakdown</h3>
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Weight</th>
                  <th>%</th>
                </tr>
              </thead>
              <tbody>
                @for (ing of recipe.ingredients; track ing.name) {
                  <tr>
                    <td>{{ing.name}}</td>
                    <td>{{ing.weight}}g</td>
                    <td>{{ing.percentage | number:'1.1-1'}}%</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <div class="flavor-badge-preview">
            @if (recipeForm.get('flavorProfile')?.value) {
              <span class="flavor-badge" [attr.data-flavor]="recipeForm.get('flavorProfile')?.value">
                {{recipeForm.get('flavorProfile')?.value}}
              </span>
            } @else {
              <span class="flavor-badge-hint">No flavor badge selected</span>
            }
          </div>

          <div class="nutrition-card">
            <h3>Nutrition Facts</h3>
            <div class="nutrition-header">
              <p>Amount Per Serving ({{recipe.servingSizeGrams}}g)</p>
            </div>

            @if (recipe.nutritionPerServing; as serving) {
              <div class="nutrition-row main">
                <span class="label">Calories</span>
                <span class="value">{{serving.calories | number:'1.0-0'}}</span>
              </div>
              <div class="nutrition-divider"></div>
              <div class="nutrition-row">
                <span class="label">Total Fat</span>
                <span class="value">{{serving.fat | number:'1.0-1'}}g</span>
              </div>
              <div class="nutrition-row">
                <span class="label">Total Carbohydrate</span>
                <span class="value">{{serving.carbs | number:'1.0-1'}}g</span>
              </div>
              <div class="nutrition-row">
                <span class="label">Protein</span>
                <span class="value">{{serving.protein | number:'1.0-1'}}g</span>
              </div>
            } @else {
              <p class="meta">Set a serving size to see per-serving nutrition.</p>
            }

            <div class="nutrition-footer">
              <div class="custom-calorie-calc">
                <h4>Calorie Calculator</h4>
                <div class="calc-inputs">
                  <div class="form-group inline">
                    <label>Weight (g)</label>
                    <input type="number" [(ngModel)]="customWeight" placeholder="Grams">
                  </div>
                  <div class="stat-box highlight">
                    <span class="label">Calories</span>
                    <span class="value">{{customCalories() | number:'1.0-0'}}</span>
                  </div>
                </div>
              </div>

              <h4>Full Batch Totals</h4>
              <div class="stats-grid">
                <div class="stat-box">
                  <span class="label">Calories</span>
                  <span class="value">{{recipe.totalNutrition.calories | number:'1.0-0'}}</span>
                </div>
                <div class="stat-box">
                  <span class="label">Fat</span>
                  <span class="value">{{recipe.totalNutrition.fat | number:'1.0-1'}}g</span>
                </div>
                <div class="stat-box">
                  <span class="label">Carbs</span>
                  <span class="value">{{recipe.totalNutrition.carbs | number:'1.0-1'}}g</span>
                </div>
                <div class="stat-box">
                  <span class="label">Protein</span>
                  <span class="value">{{recipe.totalNutrition.protein | number:'1.0-1'}}g</span>
                </div>
              </div>

              <div class="nutrition-divider"></div>
              <div class="ingredients-list-section">
                <h4>Ingredients</h4>
                <p>
                  @for (ing of recipe.ingredients; track ing.name; let last = $last) {
                    {{ing.name}}{{ last ? '' : ', ' }}
                  }
                </p>
              </div>
            </div>
          </div>
        </div>
      }

      @if (savedRecipes().length > 0) {
        <div class="card saved-recipes">
          <h2>Your Library</h2>
          <div class="recipe-list">
            @for (saved of savedRecipes(); track saved.id) {
              <div class="recipe-item">
                <div class="recipe-info" (click)="loadRecipe(saved)">
                  <span class="recipe-name">{{saved.name}}</span>
                  <span class="recipe-meta">{{saved.trueHydration | percent:'1.0-0'}} hydration</span>
                </div>
                <button class="btn-delete" (click)="confirmDeleteRecipe(saved)">√ó</button>
              </div>
            }
          </div>
        </div>
      }
    </div>
  </div>

  @if (recipeToDelete(); as recipe) {
    <div class="modal-overlay" (click)="cancelDelete()">
      <div class="modal-content card delete-confirm" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Delete Recipe?</h2>
          <button class="btn-close" (click)="cancelDelete()">√ó</button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete <strong>{{recipe.name}}</strong>? This action cannot be undone and it will be permanently removed from your cloud library.</p>
        </div>
        <div class="modal-footer-actions">
          <button class="btn-outline" (click)="cancelDelete()">Keep Recipe</button>
          <button class="btn-danger" (click)="executeDelete()">Yes, Delete Recipe</button>
        </div>
      </div>
    </div>
  }
</div>

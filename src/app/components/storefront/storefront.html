<div class="storefront-container">
  <header>
    <h1>Our Daily Bakes</h1>
    <p class="subtitle">Freshly baked in our home kitchen with love and wild yeast.</p>
  </header>

  <div class="filters-container">
    <div class="search-bar">
      <input type="text" [ngModel]="searchTerm()" (ngModelChange)="searchTerm.set($any($event))" placeholder="Search for sourdough, cookies, muffins...">
    </div>

    <div class="category-filters">
      <button [class.active]="selectedCategory() === 'ALL'" (click)="setCategory('ALL')">All</button>
      @for (cat of categories(); track cat) {
        <button [class.active]="selectedCategory() === cat" (click)="setCategory(cat)">
          {{cat === 'SPECIAL' ? 'Experimental' : (cat | titlecase)}}
        </button>
      }
    </div>

    <div class="secondary-filters">
      @if (selectedCategory() === 'BREAD' || selectedCategory() === 'ALL') {
        <div class="flavor-filters">
          <button [class.active]="selectedFlavor() === 'ALL'" (click)="setFlavor('ALL')">All Flavors</button>
          <button [class.active]="selectedFlavor() === 'SWEET'" (click)="setFlavor('SWEET')">Sweet</button>
          <button [class.active]="selectedFlavor() === 'SAVORY'" (click)="setFlavor('SAVORY')">Savory</button>
          <button [class.active]="selectedFlavor() === 'PLAIN'" (click)="setFlavor('PLAIN')">Plain</button>
        </div>
      }
      <button class="btn-info-circle" (click)="showSubscriptionInfo.set(true)" title="How Subscriptions Work">
        How Subscriptions Work üîÑ
      </button>
    </div>
  </div>

  @if (showSubscriptionInfo()) {
    <div class="subscription-modal-overlay" (click)="showSubscriptionInfo.set(false)">
      <div class="subscription-info-card card" (click)="$event.stopPropagation()">
        <button class="btn-close-modal" (click)="showSubscriptionInfo.set(false)">√ó</button>

        <header class="modal-header-pro">
          <div class="icon-circle">üîÑ</div>
          <h2>Artisan Bread Subscriptions</h2>
          <p class="tagline">The freshest way to enjoy your daily bread, automated.</p>
        </header>

        <div class="benefit-grid">
          <div class="benefit-item">
            <span class="benefit-icon">üìÖ</span>
            <div class="benefit-content">
              <h4>Weekly Delivery</h4>
              <p>Your favorites are automatically prioritized in our bake schedule every week.</p>
            </div>
          </div>

          <div class="benefit-item">
            <span class="benefit-icon">üåø</span>
            <div class="benefit-content">
              <h4>Peak Freshness</h4>
              <p>Dispatched every Monday & Tuesday. Hand-delivered or shipped within hours of leaving the oven.</p>
            </div>
          </div>

          <div class="benefit-item">
            <span class="benefit-icon">‚öôÔ∏è</span>
            <div class="benefit-content">
              <h4>Total Control</h4>
              <p>Pause, skip, or cancel anytime. Manage your subscription directly from your profile.</p>
            </div>
          </div>

          <div class="benefit-item">
            <span class="benefit-icon">‚ú®</span>
            <div class="benefit-content">
              <h4>No Extra Cost</h4>
              <p>Standard product pricing. No hidden membership fees or recurring surcharges.</p>
            </div>
          </div>
        </div>

        <footer class="modal-footer-pro">
          <p>Ready to start? Simply look for the <strong>Subscribe</strong> button on any product!</p>
          <button class="btn-primary" (click)="showSubscriptionInfo.set(false)">Got it, thanks!</button>
        </footer>
      </div>
    </div>
  }

  <div class="product-grid">
    @for (product of filteredProducts(); track product.id) {
      <div class="product-card">
        <div class="product-image">
          @if (product.images && product.images.length > 0) {
            <div class="image-scroller">
              @for (img of product.images; track img) {
                <img [src]="img" [alt]="product.name" class="main-image">
              }
            </div>
          } @else if (product.imageUrl) {
            <img [src]="product.imageUrl" [alt]="product.name" class="main-image">
          } @else {
            <div class="placeholder-icon">üçû</div>
          }

          @if (product.category === 'SPECIAL') {
            <span class="category-badge experimental">Experimental</span>
          } @else {
            <span class="category-badge">{{product.category | titlecase}}</span>
          }

          @if (product.flavorProfile) {
            <span class="flavor-badge" [attr.data-flavor]="product.flavorProfile">
              {{product.flavorProfile}}
            </span>
          }

          @if (isTopRated(product)) {
            <span class="top-rated-badge">Most Wanted</span>
          }
        </div>
        <div class="product-info">
          <h2>{{product.name}}</h2>

          <div class="rating-display" (click)="product.id && getReviews(product.id).length > 0 && toggleReviews(product.id)" [class.clickable]="product.id && getReviews(product.id).length > 0">
            <span class="stars">
              @for (star of [1,2,3,4,5]; track star) {
                <span class="star" [class.filled]="reviewService.getAverageRating(product.id || '')() >= star">‚òÖ</span>
              }
            </span>
            <span class="rating-count">({{getReviews(product.id || '').length}})</span>
            @if (product.id && getReviews(product.id).length > 0) {
              <small class="view-reviews-hint">{{ showReviewsForProduct() === product.id ? 'Hide' : 'View' }} Reviews</small>
            }
          </div>

          @if (product.id && showReviewsForProduct() === product.id && getReviews(product.id).length > 0) {
            <div class="reviews-list">
              @for (review of getReviews(product.id); track review.id) {
                <div class="review-item">
                  <div class="review-header">
                    <strong>{{review.customerName}}</strong>
                    <span class="review-stars">
                      @for (star of [1,2,3,4,5]; track star) {
                        <span class="star" [class.filled]="review.rating >= star">‚òÖ</span>
                      }
                    </span>
                  </div>
                  <p>{{review.comment}}</p>
                  @if (review.reply) {
                    <div class="baker-reply">
                      <strong>Baker's Response:</strong>
                      <p>{{review.reply}}</p>
                    </div>
                  }
                  <div class="review-footer">
                    <small>{{review.date | date:'mediumDate'}}</small>
                    <div class="review-actions">
                      @if (authService.isBaker()) {
                        <button class="btn-text" (click)="startReply(review)">{{ review.reply ? 'Edit Reply' : 'Reply' }}</button>
                      }
                      @if (authService.isBaker() || (authService.user()?.id === review.customerId)) {
                        @if (authService.user()?.id === review.customerId) {
                          <button class="btn-text" (click)="startEditReview(review)">Edit</button>
                        }
                        <button class="btn-text danger" (click)="deleteReview(review.id)">Delete</button>
                      }
                    </div>
                  </div>

                  @if (replyingToReviewId() === review.id) {
                    <div class="reply-editor">
                      <textarea [(ngModel)]="replyText" placeholder="Write your response..."></textarea>
                      <div class="reply-actions">
                        <button class="btn-small outline" (click)="cancelReply()">Cancel</button>
                        <button class="btn-small" (click)="submitReply(review.id)">Post Reply</button>
                      </div>
                    </div>
                  }

                  @if (editingReviewId() === review.id) {
                    <div class="reply-editor">
                      <div class="rating-input-small">
                        @for (star of [1,2,3,4,5]; track star) {
                          <span class="star-btn"
                                [class.active]="editReviewRating() >= star"
                                (click)="editReviewRating.set(star)">‚òÖ</span>
                        }
                      </div>
                      <textarea [(ngModel)]="editReviewText" placeholder="Edit your review..."></textarea>
                      <div class="reply-actions">
                        <button class="btn-small outline" (click)="cancelEditReview()">Cancel</button>
                        <button class="btn-small" (click)="submitEditReview(review.id)">Update Review</button>
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          }

          <p class="meta">
            {{product.trueHydration | percent:'1.0-0'}} Hydration ‚Ä¢
            {{product.category === 'SPECIAL' ? 'Limited Release' : (product.category | titlecase)}}
          </p>
          <p class="description">{{product.description || (product.category === 'SPECIAL' ? 'A new creation we are testing in the kitchen. Limited quantities available!' : 'A handcrafted artisanal creation featuring organic ingredients and long fermentation.')}}</p>

          <div class="product-footer">
            <span class="price">{{ (product.price || 12) | currency }}</span>
            <div class="btn-group">
              @if (authService.isBaker()) {
                <button class="btn-edit" (click)="editProduct(product)">Edit</button>
                <button class="btn-delete-product" (click)="deleteProduct(product)" title="Delete Product">√ó</button>
              } @else {
                <button class="btn-subscribe" (click)="subscribe(product)">Subscribe</button>
                @if (authService.isAuthenticated()) {
                  <button class="btn-review" (click)="openReviewModal(product)" title="Leave a Review">‚òÖ</button>
                }
              }
              <button class="btn-add" (click)="addToCart(product)">Add to Bag</button>
            </div>
          </div>
        </div>
      </div>
    } @empty {
      <div class="empty-state">
        <p>No products available yet. Save some recipes in the calculator to see them here!</p>
      </div>
    }
  </div>

  @if (selectedProductForReview(); as product) {
    <app-review-modal [product]="product" (close)="selectedProductForReview.set(null)"></app-review-modal>
  }

  @if (productToDelete(); as product) {
    <div class="modal-overlay" (click)="cancelDelete()">
      <div class="modal-content card delete-confirm" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Delete Product?</h2>
          <button class="btn-close" (click)="cancelDelete()">√ó</button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete <strong>{{product.name}}</strong>? This will remove it from the storefront and your cloud library permanently.</p>
        </div>
        <div class="modal-footer-actions">
          <button class="btn-outline" (click)="cancelDelete()">Keep Product</button>
          <button class="btn-danger" (click)="executeDelete()">Yes, Delete Product</button>
        </div>
      </div>
    </div>
  }
</div>

<div class="experimental-container">
  <header>
    <h1>Experimental Kitchen</h1>
    <p class="subtitle">Where our wild ideas and sourdough experiments come to life.</p>
  </header>

  <div class="product-grid">
    @for (product of experimentalProducts(); track product.id) {
      <div class="product-card">
        <div class="product-image">
          @if (product.images && product.images.length > 0) {
            <div class="image-scroller">
              @for (img of product.images; track img) {
                <img [src]="img" [alt]="product.name" class="main-image">
              }
            </div>
          } @else if (product.imageUrl) {
            <img [src]="product.imageUrl" [alt]="product.name" class="main-image">
          } @else {
            <div class="placeholder-icon">ðŸ§ª</div>
          }

          <span class="special-badge">Experimental</span>
          @if (isTopRated(product)) {
            <span class="top-rated-badge">Crowd Favorite</span>
          }
        </div>
        <div class="product-info">
          <h2>{{product.name}}</h2>

          <div class="rating-display" (click)="product.id && toggleReviews(product.id)" [class.clickable]="product.id">
            <span class="stars">
              @for (star of [1,2,3,4,5]; track star) {
                <span class="star" [class.filled]="reviewService.getAverageRating(product.id || '')() >= star">â˜…</span>
              }
            </span>
            <span class="rating-count">({{getReviews(product.id || '').length}})</span>
            @if (product.id && getReviews(product.id).length > 0) {
              <small class="view-reviews-hint">{{ showReviewsForProduct() === product.id ? 'Hide' : 'View' }} Reviews</small>
            }
          </div>

          @if (product.id && showReviewsForProduct() === product.id) {
            <div class="reviews-list">
              @for (review of getReviews(product.id); track review.id) {
                <div class="review-item">
                  <div class="review-header">
                    <strong>{{review.customerName}}</strong>
                    <span class="review-stars">
                      @for (star of [1,2,3,4,5]; track star) {
                        <span class="star" [class.filled]="review.rating >= star">â˜…</span>
                      }
                    </span>
                  </div>
                  <p>{{review.comment}}</p>
                  <small>{{review.date | date:'mediumDate'}}</small>
                </div>
              }
            </div>
          }

          <p class="meta">{{product.trueHydration | percent:'1.0-0'}} Hydration â€¢ Limited Release</p>
          <p class="description">{{product.description || 'A new creation we are testing in the kitchen. Limited quantities available!'}}</p>

          <div class="product-footer">
            <span class="price">{{ (product.price || 12) | currency }}</span>
            <div class="btn-group">
              @if (authService.isBaker()) {
                <button class="btn-edit" (click)="editProduct(product)">Edit</button>
                <button class="btn-delete-product" (click)="deleteProduct(product)" title="Delete Product">Ã—</button>
              } @else {
                <button class="btn-subscribe" (click)="subscribe(product)">Subscribe</button>
                @if (authService.isAuthenticated()) {
                  <button class="btn-review" (click)="openReviewModal(product)" title="Leave a Review">â˜…</button>
                }
              }
              <button class="btn-add" (click)="addToCart(product)">Add to Bag</button>
            </div>
          </div>
        </div>
      </div>
    } @empty {
      <div class="empty-state">
        <p>The experimental ovens are currently cooling down. Check back soon for new bakes!</p>
        @if (authService.isBaker()) {
          <button class="btn-primary" routerLink="/calculator">Start an Experiment</button>
        }
      </div>
    }
  </div>

  @if (selectedProductForReview(); as product) {
    <app-review-modal [product]="product" (close)="selectedProductForReview.set(null)"></app-review-modal>
  }

  @if (productToDelete(); as product) {
    <div class="modal-overlay" (click)="cancelDelete()">
      <div class="modal-content card delete-confirm" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Delete Experiment?</h2>
          <button class="btn-close" (click)="cancelDelete()">Ã—</button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete <strong>{{product.name}}</strong>? This experiment and all its data will be removed from your library.</p>
        </div>
        <div class="modal-footer-actions">
          <button class="btn-outline" (click)="cancelDelete()">Keep Experiment</button>
          <button class="btn-danger" (click)="executeDelete()">Yes, Delete Experiment</button>
        </div>
      </div>
    </div>
  }
</div>

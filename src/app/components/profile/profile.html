<div class="profile-container">
  <header>
    <h1>Welcome, {{authService.user()?.name}}</h1>
    <p class="subtitle">Your Artisanal Bread Journey</p>
  </header>

  <div class="profile-grid">
    <div class="card">
      <h2>Your Past Orders</h2>
      <div class="order-list">
        @for (order of userOrders(); track order.id) {
          <div class="order-card">
            <div class="order-header">
              <div class="order-id-section">
                <span class="order-number">Order #{{order.id}}</span>
                <span class="order-date">Placed on {{order.createdAt | date:'mediumDate'}}</span>
              </div>
              <span class="status-badge" [attr.data-status]="order.status">{{order.status}}</span>
            </div>

            <div class="order-body">
              <div class="order-details-grid">
                <div class="detail-item">
                  <strong>{{ order.type === 'PICKUP' ? 'Pickup Date' : 'Estimated Dispatch' }}</strong>
                  <span>{{ order.pickupDate | date:'fullDate' }}</span>
                </div>
                <div class="detail-item">
                  <strong>Fulfillment</strong>
                  <span>{{ order.type | titlecase }}</span>
                </div>
                @if (order.paymentMethod) {
                  <div class="detail-item">
                    <strong>Payment</strong>
                    <span class="payment-info">
                      <span class="card-brand">{{order.paymentMethod.brand}}</span> •••• {{order.paymentMethod.last4}}
                    </span>
                  </div>
                }
              </div>

              <div class="order-items-list">
                <h4>Order Summary</h4>
                @for (item of order.items; track item.name) {
                  <div class="item-row">
                    <span class="item-qty">{{item.quantity}}x</span>
                    <span class="item-name">{{item.name}}</span>
                    @if (hasReview(order.id, item.recipeId)) {
                      <span class="review-status-tag">Reviewed ✓</span>
                    } @else {
                      <button class="btn-review-inline" (click)="startReview(order.id, item.recipeId)" title="Leave a review">★</button>
                    }
                  </div>
                }
              </div>

              @if (order.notes) {
                <div class="order-notes-box">
                  <strong>Note to Baker:</strong>
                  <p>{{order.notes}}</p>
                </div>
              }
            </div>

            <div class="order-footer">
              <div class="order-total-info">
                @if (order.discountApplied) {
                  <span class="discount-label">Saved {{order.discountApplied | currency}}</span>
                }
                <span class="total-price">Total: {{order.totalPrice | currency}}</span>
              </div>
              <button class="btn-reorder" (click)="reorder(order)">Repeat Order</button>
            </div>
          </div>

          <!-- Inline Review Form -->
          @if (reviewingOrderId() === order.id) {
            <div class="review-form card">
              <h3>Leave a Review</h3>
              <div class="rating-input">
                @for (star of [1,2,3,4,5]; track star) {
                  <span class="star-btn"
                        [class.active]="reviewRating() >= star"
                        (click)="reviewRating.set(star)">★</span>
                }
              </div>
              <textarea [(ngModel)]="reviewComment" placeholder="How was your bread?"></textarea>
              <div class="btn-group">
                <button class="btn-primary" (click)="submitReview()">Submit</button>
                <button class="btn-outline" (click)="cancelReview()">Cancel</button>
              </div>
            </div>
          }
        } @empty {
          <p class="empty-msg">You haven't placed any orders yet. Fresh bread is waiting!</p>
          <button class="btn-primary" routerLink="/front">Visit Storefront</button>
        }
      </div>
    </div>

    <div class="card subscriptions">
      <h2>Your Perks & Loyalty</h2>
      <div class="perk-item">
        <div class="perk-info">
          <span class="perk-name">Reviewer Badge</span>
          <span class="perk-desc">10 reviews = 1 Free Loaf</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="reviewPerkProgress()"></div>
        </div>
        <div class="perk-footer">
          <span class="progress-text">{{reviewsCount() % 10}} / 10 Reviews</span>
          @if (reviewsCount() >= 10 && (reviewsCount() % 10 === 0 || reviewsCount() > 0)) {
            <button class="btn-claim" (click)="claimReviewPerk()">Claim Free Loaf</button>
          }
        </div>
      </div>

      <div class="perk-item">
        <div class="perk-info">
          <span class="perk-name">Bread Addict</span>
          <span class="perk-desc">Every 10 loaves = $8 Off</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill bread" [style.width.%]="loafPerkProgress()"></div>
        </div>
        <div class="perk-footer">
          <span class="progress-text">{{loavesPurchased() % 10}} / 10 Loaves</span>
          @if (loavesPurchased() >= 10) {
            <button class="btn-claim" (click)="claimLoafPerk()">Claim $8 Off</button>
          }
        </div>
      </div>

      <div class="subscription-section">
        <div class="header-with-action">
          <h3>Your Weekly Subscriptions</h3>
          <a routerLink="/subscriptions" class="btn-small btn-outline">Full Manager</a>
        </div>
        @for (sub of userSubscriptions(); track sub.id) {
          <div class="subscription-card" [attr.data-status]="sub.status">
            <div class="sub-header">
              <span class="sub-name">{{sub.recipeName}}</span>
              <span class="sub-status">{{sub.status}}</span>
            </div>
            <div class="sub-details">
              <span>{{sub.quantity}}x per week</span>
              <span>Next Bake: {{sub.nextBakeDate | date:'shortDate'}}</span>
            </div>
            <div class="sub-actions">
              @if (sub.status === 'ACTIVE') {
                <button class="btn-small" (click)="pauseSubscription(sub.id)">Pause</button>
              } @else if (sub.status === 'PAUSED') {
                <button class="btn-small btn-primary" (click)="resumeSubscription(sub.id)">Resume</button>
              }
              @if (sub.status !== 'CANCELLED') {
                <button class="btn-small btn-danger" (click)="cancelSubscription(sub.id)">Cancel</button>
              }
            </div>
          </div>
        } @empty {
          <p>You don't have any active subscriptions. Subscribe to your favorite loaves in the shopping bag!</p>
        }
      </div>
    </div>
  </div>
</div>
